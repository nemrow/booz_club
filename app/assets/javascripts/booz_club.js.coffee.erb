$.backstretch("<%= image_path 'bg-img.jpg' %>")
$('[name=cell]').mask("(999) 999-9999")

placesArray = []
placesCount = null

runFinder = (dataArray={}) ->
  placesArray = []
  placesCount = null

  overridingData = {}
  for input in dataArray
    overridingData[input.name] = input.value unless input.value.length == 0

  @data = {radius: "1609"}
  if @currentCoordinates
    $.extend @data, {latitude: @currentCoordinates.lat(), longitude: @currentCoordinates.lng()}

  $.extend @data, overridingData

  return unless validateData(@data)

  @latLng = new google.maps.LatLng(@data.latitude, @data.longitude)
  @map = new google.maps.Map($('#map-node')[0], {center: @latLng, zoom: 15})

  nearbyRequestData = {
    location: @latLng
    radius: @data.radius
    open_now: true
    types: ['liquor_store']
  }

  @placesService = new google.maps.places.PlacesService(@map)

  @placesService.nearbySearch(nearbyRequestData, nearbyCallback)

validateData = (data) ->
  errors = {}
  if !data.description || data.description.length < 4
    errors["description"] = "You must tell us what type of booze you want. \n\n"
  if !data.cell || !data.cell.match(/\(\d{3}\) \d{3}-\d{4}/)
    errors["cell"] = "We need a correct cell phone number. "

  if Object.keys(errors).length > 0
    errorText = ""
    for key, error of errors
      errorText += error
    swal("Oops...", errorText, "error")
    false
  else
    true

nearbyCallback = (results, status) ->
  placesCount = results.length
  if placesCount < 1
    swal("Sorry, no results found!", "Maybe you should make some moonshine?", "error")
    resetScreen()
  else
    nearbyBatcher(results, 0)

nearbyBatcher = (results, currentIndex) ->
  nextIndex = currentIndex + 5
  currentBatch = results.slice(currentIndex, nextIndex)
  for place in currentBatch
    @placesService.getDetails({placeId: place.place_id}, detailCallback)
  setTimeout ->
    nearbyBatcher(results, nextIndex) if results[nextIndex] != undefined
  , 2000

detailCallback = (place, status) ->
  placesArray.push neededPlaceAttrs(place) if status == "OK"
  placesSearchComplete() if --placesCount == 0

neededPlaceAttrs = (place) ->
  name: place.name
  address: place.address_components
  types: place.types
  phone_number: place.formatted_phone_number

clearForm = () ->
  $('.status-form input[type=text]').val("")

placesSearchComplete = () ->
  placesNames = placesArray.map (place) ->
    place.name

  subText = "We are checking inventory at #{placesNames.length} places...\n\n #{placesNames.join(', ')}"

  swal("Sweet! We will text you shortly.", subText, "success")

  @data["places"] = placesArray

  clearForm()
  resetScreen()
  $.post '/search', data

resetScreen = () ->
  $('.status-form').slideDown()
  $('.spinner').slideUp()

# Handle form submission
$('#find-form').submit (e) ->
  $('.status-form').slideUp()
  $('.spinner').slideDown()
  runFinder($(@).serializeArray())
  e.preventDefault()

####### CHART SHIT

if $("#response-rate-chart").length > 0
  responseRateChart = $("#response-rate-chart").get(0).getContext("2d")
  stockChart = $("#stock-chart").get(0).getContext("2d")
  successChart = $("#success-chart").get(0).getContext("2d")

  chartOptions = {
    segmentShowStroke : true
    tooltipTemplate: "<%%= label %> <%%= value + '%' %>"
  }

  new Chart(responseRateChart).Doughnut(window.responseRateChartData,chartOptions)
  new Chart(stockChart).Doughnut(window.stockChartData,chartOptions)
  new Chart(successChart).Doughnut(window.successChartData,chartOptions)


####### GET THE CURRENT LOCATIONNN

initializeLocation = (pos) ->
  @currentCoordinates = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude)

locationError = (err) ->
  console.warn('ERROR(' + err.code + '): ' + err.message)

mapOptions = {
  enableHighAccuracy: true
  timeout: 75000
  maximumAge: 3000
}

navigator.geolocation.getCurrentPosition(initializeLocation, locationError, mapOptions)
